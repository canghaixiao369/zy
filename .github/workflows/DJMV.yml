name: DJMV

on:
  schedule:
    - cron: '35 0 */2 * *'   # 每2天凌晨00点55分执行任务（上海时区的UTC时间）
  workflow_dispatch:   # 允许手动触发工作流

jobs:
  run_script:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai  # 设置时区为上海
      
      
    steps:
    - name: 检出代码库
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: 安装系统依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    - name: 安装Python依赖
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 aiohttp
        echo "已安装依赖包:"
        pip list | grep -E "(requests|beautifulsoup4|aiohttp|urllib3)"

    - name: 验证依赖安装
      run: |
        echo "验证Python依赖包是否已正确安装:"
        python -c "
        modules = ['requests', 'bs4', 'aiohttp', 'urllib3']
        for module in modules:
            try:
                __import__(module)
                print(f'✓ {module} 成功导入')
            except ImportError as e:
                print(f'✗ {module} 导入失败: {e}')
        "

    - name: 执行主脚本
      run: |
        python 172mv.py

    - name: 强制推送更改
      if: success()
      run: |
        git config --global user.email "772109739@qq.com"
        git config --global user.name "沧海笑"
        
        # 检查是否有任何更改（包括添加、修改或删除）
        if ! git status --porcelain tv/DJMV.txt 2>/dev/null | grep -q .; then
          echo "没有检测到tv/DJMV.txt文件的更改"
        else
          echo "检测到tv/DJMV.txt文件有更改"
        fi
        
        # 添加所有更改（包括删除）
        git add -A
        
        # 提交更改
        git commit -m "自动更新DJMV直播源 $(date '+%Y-%m-%d %H:%M:%S')" || echo "没有可提交的更改"
        
        # 强制推送更改
        git push --force